---

# Works only when fact "ansible_facts['domain']" is defined. Not always the
# case in clouds vm instances.
- name: install ssh "ansible_domain" public key
  authorized_key:
    user: "{{user['name']}}"
    key: "{{lookup('file', item)}}"
    exclusive: "{{users_exclusive_ssh_keys}}"
  with_first_found:
    - files:
        - "{{cm_user}}.{{ansible_facts['domain']}}.pub"
      paths:
        - "{{groups_dir}}/{{usergroup['name']}}/keys"
        - "{{user['home']|default(users_defaults['home'])}}/{{cm_user}}/.ssh"
      skip: true
  register: installed_domain_key
  when: ansible_facts['domain'] is defined

  # if the user has an account on the cm AND keys are not exclusive, install
  # ~/.ssh/id_rsa.pub if it does exist
- name: install ssh "id_rsa.pub" if exist on control machine
  authorized_key:
      user: "{{user['name']}}"
      key: "{{lookup('file', item)}}"
      exclusive: "{{users_exclusive_ssh_keys}}"
  with_first_found:
    - files:
        - "id_rsa.pub"
      paths: "{{user['home']|default(users_defaults['home'])}}/{{cm_user}}/.ssh"
      skip: true
  when:
    - (not installed_domain_key is changed and users_exclusive_ssh_keys) or not users_exclusive_ssh_keys

# - name: install ssh "id_rsa.pub" public key from github
#   authorized_key:
#     user: "{{user['name']}}"
#     key: "https://github.com/{{cm_user}}.keys"
#     exclusive: "{{users_exclusive_ssh_keys}}"
#     comment: "{{user['gh_ssh_key_comment']|default(omit)}}"
#   when:
#     - (not installed_domain_key is changed and users_exclusive_ssh_keys) or not users_exclusive_ssh_keys

# - debug: msg="{{lookup('first_found', params)}}"
#   loop: "{{user['authorized_keys']|default([])}}"
#   when:
#     - (not installed_domain_key is changed and users_exclusive_ssh_keys) or not users_exclusive_ssh_keys
#   vars:
#     params:
#       files:
#         - "{{item}}"
#       paths:
#         - "/home/{{cm_user}}/.ssh"
#         - "{{groups_dir}}/{{usergroup['name']}}/keys"
#         - "{{groups_dir}}/keys"
#       skip: true

- name: install user defined ssh "authorized_keys" public keys
  authorized_key:
    user: "{{user['name']}}"
    key: "{{lookup('file', lookup('first_found', params))}}"
  loop: "{{user['authorized_keys']|default([])}}"
  when:
    - (not installed_domain_key is changed and users_exclusive_ssh_keys) or not users_exclusive_ssh_keys
  vars:
    params:
      files:
        - "{{item}}"
      paths:
        - "/home/{{cm_user}}/.ssh"
        - "{{groups_dir}}/{{usergroup['name']}}/keys"
        - "{{groups_dir}}/keys"
      skip: true
